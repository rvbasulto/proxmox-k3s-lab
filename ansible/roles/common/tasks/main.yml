- name: Build /etc/hosts entries for the cluster
  ansible.builtin.set_fact:
    k3s_hosts_block: |-
      {% for host in groups['k3s'] | sort %}
      {% set host_ip = hostvars[host].ansible_default_ipv4.address | default(hostvars[host].ansible_host, true) %}
      {% if host_ip %}
      {{ host_ip }} {{ host }}
      {% endif %}
      {% endfor %}
  when: groups['k3s'] is defined

- name: Ensure cluster hostnames resolve via /etc/hosts
  ansible.builtin.blockinfile:
    path: /etc/hosts
    marker: "# {mark} k3s cluster"
    block: "{{ k3s_hosts_block }}"
    create: true
  when: k3s_hosts_block is defined
  become: true

- name: Ensure base packages are installed
  ansible.builtin.apt:
    name: "{{ common_packages }}"
    state: present
    update_cache: true
  become: true

- name: Upgrade installed packages
  ansible.builtin.apt:
    upgrade: dist
  become: true

- name: Disable swap immediately
  ansible.builtin.command: swapoff -a
  when: ansible_swaptotal_mb > 0
  become: true

- name: Comment out swap entries in fstab
  ansible.builtin.replace:
    path: /etc/fstab
    regexp: '^(?!#)(.*\sswap\s.*)$'
    replace: '# \1'
  become: true

- name: Persist required kernel modules
  ansible.builtin.copy:
    dest: /etc/modules-load.d/k8s.conf
    content: |
      overlay
      br_netfilter
    owner: root
    group: root
    mode: "0644"
  become: true

- name: Load required kernel modules
  ansible.builtin.modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - overlay
    - br_netfilter
  become: true

- name: Apply Kubernetes sysctl settings
  ansible.builtin.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: true
  loop:
    - { name: net.bridge.bridge-nf-call-iptables, value: 1 }
    - { name: net.bridge.bridge-nf-call-ip6tables, value: 1 }
    - { name: net.ipv4.ip_forward, value: 1 }
  become: true
